# 고급 가이드

## 아키텍처 개요

### 설계 철학

IMCAT UI는 다음 원칙을 따릅니다:

1. **제로 빌드** - 빌드 없이 브라우저에서 바로 사용
2. **점진적 로딩** - 필요한 모듈만 동적 로드
3. **경량화** - 코어 < 50KB, 전체 < 200KB
4. **보안 우선** - XSS 방어 기본 내장

### 코어 vs 외장 모듈

```text
코어 (Core)                    외장 (Modules)
─────────────                  ─────────────
항상 로드됨                    필요시 로드
기본 기능                      UI 컴포넌트
~48KB                          각 ~10-30KB

포함 내용:                     포함 내용:
- DOM 조작                     - Modal, Drawer
- 이벤트 버스                  - Toast, Notification
- SPA 라우터                   - Tabs, Accordion
- 상태 관리                    - DatePicker
- 스토리지                     - DataTable
- 보안 유틸                    - ...등 22개
```

---

## 자동 초기화 (AutoInit)

JavaScript 없이 `data-*` 속성만으로 컴포넌트를 생성할 수 있습니다.

### Dropdown 자동 초기화

```html
<!-- data-dropdown 속성만 추가 -->
<button data-dropdown='{"items": [
  {"label": "편집", "icon": "edit"},
  {"label": "삭제", "icon": "delete", "danger": true}
]}'>
  메뉴
</button>
```

### Tooltip 자동 초기화

```html
<button data-tooltip="도움말 텍스트">
  ?
</button>

<!-- 위치 지정 -->
<span data-tooltip="설명" data-tooltip-position="bottom">
  아이콘
</span>
```

### Tabs 자동 초기화

```html
<div data-tabs>
  <button data-tab="tab1" class="is-active">탭 1</button>
  <button data-tab="tab2">탭 2</button>
</div>
<div data-tab-panel="tab1" class="is-active">내용 1</div>
<div data-tab-panel="tab2">내용 2</div>
```

### 자동 초기화 지원 컴포넌트

| 컴포넌트 | 속성 | 예시 |
|----------|------|------|
| Dropdown | `data-dropdown` | `data-dropdown='{"items":[...]}'` |
| Tooltip | `data-tooltip` | `data-tooltip="텍스트"` |
| Tabs | `data-tabs` | `data-tab="id"` |
| Accordion | `data-accordion` | `data-accordion-item` |
| Modal Trigger | `data-modal` | `data-modal="#modal-id"` |

---

## SPA 페이지 작성 패턴

### 폴더 구조

```text
project/
├── index.html          # 메인 레이아웃
└── views/              # SPA 페이지들
    ├── home.html
    ├── dashboard.html
    ├── users/
    │   ├── list.html
    │   └── detail.html
    └── settings.html
```

### 메인 레이아웃 (index.html)

```html
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>My App</title>
  <link rel="stylesheet" href="dist/imcat-ui.css">
</head>
<body>
  <!-- 헤더 (고정) -->
  <header class="app-header">
    <nav>
      <a catui-href="views/home.html">홈</a>
      <a catui-href="views/dashboard.html">대시보드</a>
      <a catui-href="views/users/list.html">사용자</a>
    </nav>
  </header>
  
  <!-- 콘텐츠 영역 (동적 교체) -->
  <main id="app-content"></main>
  
  <!-- 푸터 (고정) -->
  <footer class="app-footer">
    &copy; 2025 My App
  </footer>
  
  <script type="module">
    import IMCAT from './dist/imcat-ui.min.js';
    
    // 초기 페이지
    IMCAT.view.navigate('views/home.html');
  </script>
</body>
</html>
```

### 뷰 페이지 (views/home.html)

```html
<!-- 페이지 헤더 -->
<div class="page-header">
  <h1>홈</h1>
  <p>환영합니다!</p>
</div>

<!-- 페이지 콘텐츠 -->
<div class="page-content">
  <div class="card">
    <div class="card__body">
      콘텐츠...
    </div>
  </div>
</div>

<!-- 페이지 스크립트 -->
<script type="module">
  // 이 스크립트는 페이지 로드 시 실행됩니다
  console.log('홈 페이지 로드됨');
  
  // 모듈 사용
  const Feedback = await IMCAT.use('feedback');
  Feedback.Toast.info('환영합니다!');
</script>
```

### 페이지 간 데이터 전달

```javascript
// 발신 페이지
IMCAT.view.navigate('views/detail.html', { id: 123 });

// 수신 페이지 (detail.html)
const params = IMCAT.view.params();
console.log(params.id); // '123'

// 또는 전역 상태 사용
const store = IMCAT.globalState.use('app');
store.selectedId = 123;
```

---

## 메모리 관리

### 문제: 메모리 누수

SPA에서 페이지를 이동할 때 이전 페이지의 모듈 인스턴스가 정리되지 않으면 메모리 누수가 발생합니다.

```javascript
// ❌ 잘못된 예 - 메모리 누수
const modal = new Overlays.Modal({ title: '알림' });
// 페이지 이동 시 modal이 정리되지 않음
```

### 해결 1: registerInstance()

```javascript
// ✅ 올바른 예 - 자동 정리
const modal = new Overlays.Modal({ title: '알림' });
IMCAT.view.registerInstance(modal);
// 페이지 이동 시 자동으로 modal.destroy() 호출
```

### 해결 2: 수동 destroy()

```javascript
// ✅ 수동 정리
const modal = new Overlays.Modal({ title: '알림' });

// 사용 후 정리
modal.hide();
modal.destroy();
```

### 전역 변수 주의사항

SPA에서는 `const`/`let` 재선언 오류가 발생할 수 있습니다:

```javascript
// ❌ 페이지 재진입 시 오류
const state = IMCAT.state.create({ count: 0 });

// ✅ window 객체 사용
if (window.pageState?.destroy) window.pageState.destroy();
window.pageState = IMCAT.state.create({ count: 0 });
```

---

## 이벤트 리스너 관리

### 페이지별 이벤트

```javascript
// ❌ 중복 등록됨
document.getElementById('btn').addEventListener('click', handler);

// ✅ onclick 사용 (자동 덮어쓰기)
document.getElementById('btn').onclick = handler;

// ✅ 또는 플래그 사용
if (!window.btnListenerAdded) {
  document.getElementById('btn').addEventListener('click', handler);
  window.btnListenerAdded = true;
}
```

### 전역 이벤트

```javascript
// 이벤트 버스는 자동 관리 안됨
// 페이지 이동 전 직접 해제 필요

const handler = (data) => console.log(data);
IMCAT.on('custom:event', handler);

// 페이지 이동 전
IMCAT.off('custom:event', handler);
```

---

## 예제 페이지 구조

### examples 폴더

```text
examples/
├── index.html          # 예제 메인 페이지
├── assets/             # 공용 리소스
├── views/
│   ├── modules/        # 모듈별 예제
│   │   ├── overlays.html
│   │   ├── feedback.html
│   │   ├── dropdown.html
│   │   ├── navigation.html
│   │   └── ...
│   ├── static/         # 정적 컴포넌트 예제
│   │   ├── buttons.html
│   │   ├── forms.html
│   │   └── ...
│   └── design/         # 디자인 시스템 예제
│       ├── colors.html
│       ├── typography.html
│       └── ...
└── layouts/
    └── sidebar.html    # 사이드바
```

### 예제 실행

```bash
npm run serve
# http://localhost:3000/examples/
```

---

## 디버깅 팁

### 콘솔 로그

```javascript
// 모듈 로드 확인
IMCAT.on('module:loaded', (name) => {
  console.log('모듈 로드됨:', name);
});

// 페이지 이동 추적
IMCAT.view.afterLoad((path) => {
  console.log('페이지:', path);
});
```

### 상태 확인

```javascript
// 전역 상태 확인
console.log(IMCAT.globalState.list());

// 등록된 인스턴스 확인
console.log(IMCAT.view._instances);
```

### 일반적인 오류

| 오류 | 원인 | 해결 |
|------|------|------|
| `Cannot read properties of undefined` | DOM 요소 없음 | 선택자 확인, 로드 타이밍 확인 |
| `Module not found` | 모듈명 오타 | `overlays`, `feedback` 등 정확히 |
| `already declared` | 재선언 | `window.xxx` 또는 조건부 선언 |
| `destroy is not a function` | 잘못된 인스턴스 | 모듈 클래스 확인 |

---

## 성능 최적화

### 1. 모듈 사전 로드

```javascript
// 자주 사용하는 모듈 미리 로드
IMCAT.loader.preload('overlays');
IMCAT.loader.preload('feedback');
```

### 2. 이미지 레이지 로딩

```html
<img loading="lazy" src="large-image.jpg">
```

### 3. 디바운스/스로틀

```javascript
// 검색 입력
const search = IMCAT.debounce(async (query) => {
  const results = await fetchResults(query);
  renderResults(results);
}, 300);

input.addEventListener('input', (e) => search(e.target.value));
```

### 4. 가상 스크롤

대량 데이터는 DataTable의 가상 스크롤 사용:

```javascript
const table = new DataViz.DataTable('#table', {
  virtualScroll: true,
  rowHeight: 48,
  data: largeDataset // 10000+ rows
});
```

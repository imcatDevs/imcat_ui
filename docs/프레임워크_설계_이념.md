# IMCAT UI 프레임워크 설계 이념

## 📋 개요

IMCAT UI는 ES6 순수 자바스크립트 기반의 경량 웹 프레임워크입니다.
복잡한 빌드 과정 없이 CSS/JS 파일만 로드하면 즉시 사용할 수 있는 **제로 빌드** 프레임워크를 지향합니다.

---

## 🎯 핵심 설계 원칙

### 1. **즉시 사용 가능 (Zero Build)**

```html
<!-- 단 두 줄로 시작 -->
<link rel="stylesheet" href="imcat-ui.css">
<script type="module" src="imcat-ui.js"></script>
```

- 빌드 도구 불필요
- NPM 설치 불필요
- 복잡한 설정 불필요
- CDN 또는 로컬 파일로 즉시 시작

### 2. **동적 모듈 로딩 (Dynamic Module Loading)**

필요한 모듈만 필요한 시점에 로딩하여 초기 로딩 속도를 최적화합니다.

```javascript
// 자동 동적 로딩
const modal = await IMCAT.use('modal');
modal.show('환영합니다!');

// 사용하지 않는 모듈은 로드되지 않음
```

#### 장점

- 초기 페이지 로드 시간 단축
- 메모리 사용량 최적화
- 네트워크 대역폭 절약

### 3. **경량 모듈화 (Lightweight Modularity)**

각 모듈은 독립적이며 최소한의 의존성만 가집니다.

```text
imcat-ui/
├── core/            # 코어 (항상 로드)
│   ├── dom.js      # DOM 유틸리티
│   ├── event.js    # 이벤트 시스템
│   ├── loader.js   # 모듈 로더
│   ├── router.js   # 뷰 라우터 (SPA)
│   ├── loading.js  # 로딩 인디케이터
│   ├── security.js # XSS 보안 필터
│   ├── api.js      # API 유틸리티
│   └── utils.js    # 기본 유틸리티
└── modules/         # 선택적 모듈 (필요시 로드)
    ├── modal/
    ├── dropdown/
    ├── tooltip/
    └── ...
```

### 4. **코어 최소화 (Minimal Core)**

코어는 다음만 포함합니다:

- **DOM 조작 유틸리티**: 선택자, 이벤트, 클래스 조작
- **이벤트 시스템**: 커스텀 이벤트, 이벤트 버스
- **모듈 로더**: 동적 import 관리
- **뷰 라우터**: SPA 페이지 라우팅 및 렌더링
- **로딩 인디케이터**: 페이지/모듈 로딩 표시
- **XSS 보안 필터**: 자동 이스케이프 및 새니타이징
- **API 유틸리티**: JSON 통일 응답형식, HTTP 요청 래퍼
- **기본 유틸리티**: 타입 체크, 객체 조작

#### 코어 크기 목표

< 15KB (minified + gzipped) - SPA 라우터 포함

### 5. **순수 ES6+ 자바스크립트 (Pure ES6+ JavaScript)**

- TypeScript 미사용
- Babel 미사용
- 현대 브라우저 네이티브 기능 활용
- ES6 모듈 시스템 (`import`/`export`)
- 최신 JavaScript API 적극 활용

#### 지원 브라우저

- Chrome/Edge 90+
- Firefox 88+
- Safari 14+

### 6. **직관적인 API (Intuitive API)**

```javascript
// jQuery 스타일의 친숙함 + 현대적 접근
IMCAT('#app')
  .addClass('active')
  .on('click', handleClick)
  .html('<h1>Hello</h1>');

// 체이닝 지원
IMCAT.create('div')
  .addClass('card')
  .append(IMCAT.create('p').text('내용'))
  .appendTo('#container');

// 비동기 모듈 로딩 (자동 로딩 표시)
const chart = await IMCAT.use('chart');
chart.render('#chart', data);

// 로딩 인디케이터 (코어 내장)
IMCAT.loading.show('데이터 로딩 중...');
await loadData();
IMCAT.loading.hide();

// API 요청 (코어 내장)
const users = await IMCAT.api.get('/api/users');
if (users.success) {
  console.log(users.data);
}

// POST 요청
const result = await IMCAT.api.post('/api/users', {
  name: 'John',
  email: 'john@example.com'
});
```

```html
<!-- SPA 라우팅 (코어 내장, 설정 불필요) -->
<!-- 클릭 시 자동 로딩 표시 -->
<a catui-href="views/home.html">홈</a>
<a catui-href="views/products.html">상품</a>
<a catui-href="views/about.html">회사소개</a>
```

---

## 🏗️ 아키텍처 구조

### 레이어 구조

```text
┌──────────────────────────────────────────────┐
│      Application Layer                       │  ← 사용자 코드
├──────────────────────────────────────────────┤
│      Module Layer (동적)                      │  ← 선택적 컴포넌트
│  Modal, Dropdown, Chart, etc.                │
├──────────────────────────────────────────────┤
│      Core Layer (항상 로드)                   │  ← 필수 기능
│  DOM, Event, Loader, View Router,           │
│  Loading, Security, Utils                    │
└──────────────────────────────────────────────┘
```

### 모듈 타입

1. **코어 모듈** (Core Modules)
   - 항상 로드됨
   - 프레임워크의 기반
   - 최소한의 기능만 포함

2. **기본 모듈** (Standard Modules)
   - 자주 사용되는 UI 컴포넌트
   - 개별적으로 동적 로딩
   - 예: Modal, Dropdown, Tooltip, Tabs

3. **확장 모듈** (Extended Modules)
   - 특수 용도의 컴포넌트
   - 필요시에만 로딩
   - 예: Chart, DataTable, RichEditor

4. **플러그인** (Plugins)
   - 서드파티 통합
   - 완전히 독립적
   - 예: Analytics, i18n, State Management

---

## 🚀 SPA 뷰 라우팅 시스템

### 핵심 개념

IMCAT UI는 **SPA(Single Page Application) 라우팅을 코어에 내장**하여 별도의 라우터 라이브러리 없이도 페이지 전환이 가능합니다.

**핵심 특징:**

- 라우트 설정 코드 불필요
- `catui-href` 속성에 파일 경로를 직접 지정
- 프레임워크가 자동으로 경로를 분석하여 SPA로 동작

### 사용 방법 - 설정 불필요

**라우트 설정 없이** `catui-href` 속성에 뷰 파일 경로를 직접 지정하면 자동으로 SPA 동작합니다.

```html
<!-- 일반 링크 (페이지 새로고침) -->
<a href="views/products.html">상품 보기</a>

<!-- SPA 링크 (부분 렌더링) - 파일 경로 직접 지정 -->
<a catui-href="views/products.html">상품 보기 (HTML)</a>
<a catui-href="views/about.html">회사소개</a>
<a catui-href="views/user/profile.html">프로필</a>

<!-- PHP 환경도 지원 -->
<a catui-href="views/products.php">상품 보기 (PHP)</a>
<a catui-href="views/dashboard.php">대시보드</a>
```

**핵심:**

- ✅ `catui-href` - SPA로 동작, 파일 경로 자동 분석
- ✅ `href` - 일반 링크, 페이지 새로고침
- ✅ 라우트 설정 코드 불필요
- ✅ URL은 파일 경로 기반으로 자동 변경
- ✅ HTML/PHP 모두 지원 - 환경에 맞게 선택 가능

### 콘텐츠 영역 설정 (옵션)

```javascript
// 기본값: #app
// 필요시 변경 가능
IMCAT.view.setContainer('#main-content');
```

### 뷰 페이지에서 IMCAT 사용

렌더링되는 뷰 페이지에서도 IMCAT 객체를 자동으로 상속받아 사용할 수 있습니다.

#### views/products.html

```html
<div class="products-page">
  <h1>상품 목록</h1>
  <ul id="product-list"></ul>
</div>

<script>
// IMCAT이 자동으로 사용 가능
IMCAT('#product-list').html(`
  <li><a catui-href="/products/1">상품 1</a></li>
  <li><a catui-href="/products/2">상품 2</a></li>
`);

// 동적 모듈 사용 (메모리 누수 방지)
const modal = await IMCAT.use('modal');
const modalInstance = new modal.Modal();

// 인스턴스 등록 - 뷰 전환 시 자동 정리됨
IMCAT.view.registerInstance(modalInstance);

IMCAT('.product-item').on('click', (e) => {
  modalInstance.show('상품 상세');
});

// 페이지 이탈 시 자동으로 modalInstance.destroy() 호출됨
</script>
```

### URL 파라미터 전달

파일 경로에 쿼리 파라미터를 추가하여 데이터를 전달할 수 있습니다.

```html
<!-- 파라미터와 함께 페이지 이동 -->
<a catui-href="views/product-detail.html?id=123">상품 상세</a>
<a catui-href="views/user/edit.html?userId=456&mode=edit">프로필 수정</a>
```

```javascript
// views/product-detail.html
<script>
// URL 파라미터 접근
const params = IMCAT.view.params(); // { id: '123' }
const productId = params.id;

// 상품 데이터 로드
fetch(`/api/products/${productId}`)
  .then(res => res.json())
  .then(data => {
    IMCAT('#product-name').text(data.name);
  });
</script>
```

### 라이프사이클 훅

```javascript
// 뷰 로드 전
IMCAT.view.beforeLoad((to, from) => {
  console.log(`${from} → ${to} 이동 중...`);
  // 로딩 표시
  IMCAT('#loading').show();
});

// 뷰 로드 후
IMCAT.view.afterLoad((route) => {
  console.log(`${route} 로드 완료`);
  IMCAT('#loading').hide();
});

// 에러 처리
IMCAT.view.onError((error) => {
  console.error('뷰 로드 실패:', error);
  IMCAT.view.navigate('views/404.html');
});
```

### 자동 로딩 인디케이터

뷰 페이지 렌더링 시 자동으로 로딩 표시가 나타납니다.

```javascript
// 기본 로딩 표시 (자동)
// 페이지 전환 시 자동으로 로딩 인디케이터 표시
<a catui-href="views/products.html">상품</a>
// 클릭 → 로딩 표시 → 페이지 로드 → 로딩 숨김

// 로딩 스타일 커스터마이징
IMCAT.loading.config({
  style: 'spinner', // 'spinner', 'bar', 'dots'
  color: '#007bff',
  position: 'center', // 'center', 'top'
  delay: 200 // 200ms 이하는 로딩 표시 안함 (빠른 로딩)
});

// 수동 제어
IMCAT.loading.show(); // 로딩 표시
IMCAT.loading.hide(); // 로딩 숨김

// 로딩 메시지 설정
IMCAT.loading.show('데이터 로드 중...');

// 프로그레스 바
IMCAT.loading.progress(50); // 50% 진행률
```

**자동 로딩 동작:**

```javascript
// 뷰 전환 시 자동 로딩
IMCAT.view.navigate('views/products.html');
// 1. 로딩 표시 자동 시작
// 2. 페이지 로드
// 3. 렌더링 완료 후 자동 숨김

// 모듈 로딩 시 자동 로딩
const modal = await IMCAT.use('modal');
// 1. 로딩 표시 (모듈 다운로드 중)
// 2. 모듈 로드 완료
// 3. 로딩 숨김

// 커스텀 로딩 처리
IMCAT.view.beforeLoad(() => {
  IMCAT.loading.show('페이지 로딩 중...');
});

IMCAT.view.afterLoad(() => {
  IMCAT.loading.hide();
});
```

**로딩 스타일 옵션:**

```css
/* 기본 스피너 */
.imcat-loading-spinner { }

/* 프로그레스 바 */
.imcat-loading-bar { }

/* 도트 애니메이션 */
.imcat-loading-dots { }

/* 커스텀 CSS 변수 */
:root {
  --imcat-loading-color: #007bff;
  --imcat-loading-bg: rgba(255, 255, 255, 0.9);
  --imcat-loading-size: 40px;
}
```

### 프로그래밍 방식 네비게이션

```javascript
// 페이지 이동
IMCAT.view.navigate('views/about.html');
IMCAT.view.navigate('views/products.html?id=123');

// 뒤로 가기
IMCAT.view.back();

// 앞으로 가기
IMCAT.view.forward();

// 현재 경로
const currentPath = IMCAT.view.current(); // 'views/products.html'
```

### SPA 라우팅 장점

- ✅ **설정 불필요**: 라우트 매핑 코드 작성 불필요
- ✅ **제로 의존성**: 추가 라우터 라이브러리 불필요
- ✅ **간편한 사용**: `catui-href` 속성만으로 SPA 구현
- ✅ **완전한 통합**: 뷰 페이지에서 IMCAT 기능 즉시 사용
- ✅ **자동 로딩 표시**: 페이지 렌더링 시 로딩 인디케이터 자동 표시
- ✅ **메모리 관리**: 뷰 전환 시 인스턴스 자동 정리
- ✅ **보안 내장**: 경로 순회 공격 자동 차단

---

## 🧹 인스턴스 관리 및 메모리 누수 방지

### 자동 메모리 관리

IMCAT UI는 **SPA 환경에서 메모리 누수를 자동으로 방지**합니다. 뷰 전환 시 등록된 모든 인스턴스가 자동으로 정리됩니다.

### 인스턴스 등록

```javascript
// views/products.html
<script>
// 모듈 인스턴스 생성
const Modal = await IMCAT.use('modal');
const modalInstance = new Modal();

// 인스턴스 등록 - 뷰 이탈 시 자동 정리
IMCAT.view.registerInstance(modalInstance);

// 사용
modalInstance.show('상품 정보');

// 다른 페이지로 이동하면 자동으로 modalInstance.destroy() 호출됨
</script>
```

### 메모리 누수 방지 원리

```javascript
// 내부 동작 (사용자가 직접 할 필요 없음)
1. 뷰 A 로드 → 인스턴스 등록
2. 뷰 B로 이동 시작
3. 뷰 A의 모든 인스턴스 destroy() 자동 호출
4. 이벤트 리스너 제거
5. DOM 참조 해제
6. 메모리 누수 방지 ✓
```

### 모범 사례

```javascript
// ✅ 올바른 방법 - 인스턴스 등록
const modal = new Modal();
IMCAT.view.registerInstance(modal);
modal.show('내용');

// ❌ 주의 - 등록하지 않으면 메모리 누수 가능
const modal = new Modal();
modal.show('내용'); // 페이지 이탈 시 정리되지 않음
```

### destroy() 메서드 구현

모든 모듈은 `destroy()` 메서드를 구현해야 합니다:

```javascript
class MyModule {
  constructor() {
    this.element = document.createElement('div');
    this.handler = () => console.log('click');
    this.element.addEventListener('click', this.handler);
  }
  
  destroy() {
    // 이벤트 리스너 제거
    this.element.removeEventListener('click', this.handler);
    
    // DOM 제거
    this.element.remove();
    
    // 참조 해제
    this.element = null;
    this.handler = null;
  }
}
```

### 자동 정리 대상

다음 항목들이 자동으로 정리됩니다:

- ✅ 등록된 모든 모듈 인스턴스
- ✅ 이벤트 리스너 (destroy() 내에서)
- ✅ DOM 요소 (destroy() 내에서)
- ✅ 타이머/인터벌 (destroy() 내에서)
- ✅ 외부 리소스 (destroy() 내에서)

### 메모리 관리 장점

1. **자동화** - 수동 정리 불필요
2. **안전성** - 메모리 누수 방지
3. **일관성** - 모든 뷰에서 동일한 동작
4. **편의성** - 개발자가 신경 쓸 필요 없음

---

## 🔒 XSS 보안 필터링 시스템

### 보안 우선 설계

IMCAT UI는 **XSS(Cross-Site Scripting) 공격 방지를 코어에 내장**하여 안전한 웹 애플리케이션 개발을 보장합니다.

**보안 원칙:**

- 모든 사용자 입력은 기본적으로 이스케이프 처리
- HTML 삽입 시 자동 새니타이징
- 명시적 허용 시에만 원본 HTML 렌더링

### 자동 이스케이프 처리

기본적으로 모든 텍스트 삽입은 자동으로 이스케이프됩니다.

```javascript
// 안전: 자동 이스케이프
const userInput = '<script>alert("XSS")</script>';
IMCAT('#output').text(userInput);
// 결과: &lt;script&gt;alert("XSS")&lt;/script&gt; (텍스트로 표시)

// 안전: HTML 엔티티 자동 변환
IMCAT('#message').text(userName); // 모든 특수 문자 이스케이프
```

### HTML 삽입 - 자동 새니타이징

`html()` 메서드는 자동으로 위험한 태그와 속성을 제거합니다.

```javascript
// 자동 새니타이징
const userHtml = '<p>안전한 내용</p><script>alert("XSS")</script>';
IMCAT('#content').html(userHtml);
// 결과: <p>안전한 내용</p> (script 태그 제거됨)

// 위험한 이벤트 핸들러 자동 제거
const malicious = '<img src="x" onerror="alert(1)">';
IMCAT('#image').html(malicious);
// 결과: <img src="x"> (onerror 속성 제거됨)
```

**자동 제거 대상:**

- `<script>`, `<iframe>`, `<object>`, `<embed>` 태그
- `on*` 이벤트 핸들러 (`onclick`, `onerror` 등)
- `javascript:` URL
- `data:` URL (일부 예외 제외)

### 신뢰할 수 있는 HTML 렌더링

명시적으로 신뢰할 수 있는 HTML을 렌더링할 때만 `rawHtml()` 사용:

```javascript
// 주의: 새니타이징 없이 원본 HTML 삽입
// 신뢰할 수 있는 소스에서만 사용!
const trustedHtml = '<div class="safe">관리자 작성 콘텐츠</div>';
IMCAT('#admin-content').rawHtml(trustedHtml);
```

**사용 지침:**

```javascript
// 좋은 예: 서버에서 검증된 콘텐츠
const sanitizedContent = await fetch('/api/content').then(r => r.text());
IMCAT('#content').rawHtml(sanitizedContent);

// 나쁜 예: 사용자 입력 직접 사용
const userInput = document.querySelector('#user-input').value;
IMCAT('#output').rawHtml(userInput); // 위험!

// 올바른 방법: 자동 새니타이징 사용
IMCAT('#output').html(userInput); // 안전
```

### 뷰 페이지 자동 보호

SPA 뷰 페이지에서 로드된 콘텐츠도 자동으로 보호됩니다.

```javascript
// views/user-profile.html
<script>
// URL 파라미터 자동 이스케이프
const params = IMCAT.view.params();
const userName = params.name; // 자동으로 안전하게 처리됨

// 표시 시 자동 이스케이프
IMCAT('#user-name').text(userName); // 안전

// API 응답도 자동 새니타이징
fetch('/api/user-bio')
  .then(r => r.text())
  .then(bio => {
    IMCAT('#bio').html(bio); // 자동 새니타이징
  });
</script>
```

### 속성 값 보호

DOM 속성 설정 시에도 자동으로 보호됩니다.

```javascript
// 안전: 속성 값 자동 이스케이프
const userValue = '" onclick="alert(1)"';
IMCAT('#input').attr('value', userValue);
// 결과: value="&quot; onclick=&quot;alert(1)&quot;" (안전하게 이스케이프)

// 안전: data 속성
IMCAT('#element').data('user-input', maliciousInput); // 자동 이스케이프
```

### CSS 인젝션 방지

스타일 설정 시에도 보안 검증이 적용됩니다.

```javascript
// 안전: 위험한 CSS 값 필터링
const userColor = 'red; background: url(javascript:alert(1))';
IMCAT('#element').css('color', userColor);
// javascript: URL 자동 제거
```

### Content Security Policy (CSP) 지원

IMCAT UI는 엄격한 CSP 정책과 호환됩니다.

```html
<!-- CSP 헤더 예시 -->
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';">

<script type="module">
  // IMCAT은 인라인 이벤트 핸들러를 사용하지 않음
  import IMCAT from './imcat-ui.js';
  
  // CSP 호환
  IMCAT('#button').on('click', handleClick);
</script>
```

### 보안 유틸리티 API

명시적인 보안 처리를 위한 유틸리티 제공:

```javascript
// HTML 이스케이프
const escaped = IMCAT.escape('<script>alert(1)</script>');
// 결과: "&lt;script&gt;alert(1)&lt;/script&gt;"

// HTML 새니타이징
const sanitized = IMCAT.sanitize(userHtml);
// 위험한 태그/속성 제거된 안전한 HTML 반환

// URL 검증
const isSafe = IMCAT.isSafeUrl(url);
if (isSafe) {
  window.location.href = url;
}

// 경로 검증
const isValidPath = IMCAT.validatePath('views/products.html');
if (isValidPath) {
  IMCAT.view.navigate('views/products.html');
}

// 파일명 검증 (경로 순회 체크)
const isSafeFilename = IMCAT.isSafeFilename(userInput);
// '../../../etc/passwd' -> false
// 'products.html' -> true

// URL 파라미터 검증
const cleanParam = IMCAT.sanitizeParam(params.id);
// SQL 인젝션 패턴 제거
```

### 보안 체크리스트

**자동으로 보호되는 것:**

- `.text()` - 모든 텍스트 자동 이스케이프
- `.html()` - HTML 자동 새니타이징
- `.attr()` - 속성 값 자동 이스케이프
- `.data()` - 데이터 속성 자동 이스케이프
- `.css()` - 위험한 CSS 값 필터링
- 뷰 파라미터 - URL 파라미터 자동 이스케이프
- 뷰 경로 - 경로 순회 공격 자동 차단
- 파일 확장자 - `.html`, `.php`만 허용 (안전한 뷰 파일)
- URL 인코딩 - 우회 시도 자동 탐지

**주의가 필요한 것:**

- `.rawHtml()` - 새니타이징 없음, 신뢰할 수 있는 소스만
- 서버 응답 - 서버 측에서도 검증 권장
- 외부 라이브러리 - 서드파티 라이브러리 보안 검토
- 동적 경로 - 사용자 입력 기반 경로는 검증 필수

### 경로 순회(Path Traversal) 공격 방어

SPA 뷰 라우팅에서 `../../` 같은 경로 순회 공격을 자동으로 차단합니다.

```javascript
// 자동 차단: 경로 순회 시도
<a catui-href="../../../etc/passwd">악성 링크</a>
// 프레임워크가 자동으로 차단하고 에러 발생

// 자동 차단: 절대 경로
<a catui-href="/etc/passwd">절대 경로</a>
// views/ 폴더 외부 접근 차단

// ✅ 안전: 허용된 경로만
<a catui-href="views/products.html">안전</a>
<a catui-href="views/user/profile.html">안전</a>
```

**경로 검증 규칙:**

```javascript
// 프로그래밍 방식에서도 자동 검증
IMCAT.view.navigate('../../../admin.html'); // 에러 발생
IMCAT.view.navigate('/absolute/path.html'); // 에러 발생

// ✅ 안전한 경로만 허용
IMCAT.view.navigate('views/safe.html'); // 허용
```

**자동 차단 대상:**

- `../` 포함 경로 (상위 디렉토리 접근)
- 절대 경로 (`/`로 시작)
- `views/` 폴더 외부 경로
- null byte (`%00`) 포함
- URL 인코딩 우회 시도 (`%2e%2e%2f` 등)

### 인젝션 공격 방어

#### URL 파라미터 인젝션 방어

URL 파라미터를 통한 인젝션 공격을 자동으로 차단합니다.

```javascript
// views/user.html
<script>
// 자동 이스케이프 및 검증
const params = IMCAT.view.params();

// ❌ 악의적인 파라미터
// ?name=<script>alert(1)</script>
const userName = params.name; 
// 자동 이스케이프: &lt;script&gt;alert(1)&lt;/script&gt;

// ❌ SQL 인젝션 시도
// ?id=' OR '1'='1
const userId = params.id;
// 자동 이스케이프: \' OR \'1\'=\'1

// ✅ 안전하게 사용
IMCAT('#user-name').text(userName); // 안전
</script>
```

#### 파일 경로 검증

뷰 파일 로드 시 안전한 경로만 허용합니다.

```javascript
// ❌ 차단: 경로 순회
IMCAT.view.navigate('views/../../config.js'); // 에러

// ❌ 차단: 확장자 검증
IMCAT.view.navigate('views/malicious.exe'); // 에러
IMCAT.view.navigate('views/script.js'); // 에러

// ❌ 차단: 특수 문자
IMCAT.view.navigate('views/file;rm -rf.html'); // 에러

// ✅ 허용: 안전한 경로
IMCAT.view.navigate('views/products.html'); // 허용
IMCAT.view.navigate('views/user/profile.php'); // 허용 (PHP 환경)
IMCAT.view.navigate('views/dashboard.html'); // 허용
```

**파일 경로 검증 규칙:**

- `.html`, `.php` 확장자만 허용 (정적 HTML 및 PHP 라우터 환경 지원)
- 영문, 숫자, 하이픈(`-`), 언더스코어(`_`), 슬래시(`/`)만 허용
- `views/` 폴더 내부만 허용
- 경로 정규화 후 재검증

#### DOM 기반 인젝션 방어

```javascript
// ✅ 안전: location.hash 자동 검증
// URL: #<img src=x onerror=alert(1)>
const hash = location.hash.slice(1);
IMCAT('#content').text(hash); // 자동 이스케이프

// ✅ 안전: 검색 쿼리
const searchQuery = new URLSearchParams(location.search).get('q');
IMCAT('#search-result').text(searchQuery); // 자동 이스케이프

// ❌ 위험: 직접 DOM 조작
document.getElementById('output').innerHTML = hash; // 사용 금지!

// ✅ 안전: IMCAT 사용
IMCAT('#output').html(hash); // 자동 새니타이징
```

#### 동적 스크립트 로딩 방어

```javascript
// ❌ 차단: 외부 스크립트 동적 로드 제한
const userScript = params.script; // "https://evil.com/xss.js"
// IMCAT.use()는 내부 모듈만 로드 가능

// ✅ 안전: 화이트리스트 기반
const allowedModules = ['modal', 'dropdown', 'tooltip'];
if (allowedModules.includes(moduleName)) {
  const module = await IMCAT.use(moduleName);
}

// ❌ 차단: eval 및 Function 생성자
eval(userCode); // 절대 사용 금지
new Function(userCode)(); // 절대 사용 금지
```

### 보안 모범 사례

```javascript
// ✅ DO: 기본 메서드 사용
IMCAT('#output').text(userInput);
IMCAT('#content').html(apiResponse); // 자동 새니타이징

// ✅ DO: 경로 검증
if (IMCAT.validatePath(viewPath)) {
  IMCAT.view.navigate(viewPath);
}

// ✅ DO: 명시적 검증
if (IMCAT.isSafeUrl(url)) {
  IMCAT('#link').attr('href', url);
}

// ❌ DON'T: 직접 DOM 조작
document.getElementById('output').innerHTML = userInput; // 위험!

// ❌ DON'T: rawHtml 사용 자제
IMCAT('#output').rawHtml(userInput); // 위험!

// ❌ DON'T: eval 사용 금지
eval(userCode); // 절대 사용 금지

// ❌ DON'T: 경로 검증 우회 시도
IMCAT.view.navigate(userInput); // 위험! 검증 필요

// ✅ DO: 서버 측 검증과 함께 사용
// 클라이언트 보안은 추가 방어선
```

### 보안 계층 방어 (Defense in Depth)

IMCAT UI는 다층 보안 방어를 제공합니다:

#### 계층 1: 입력 검증

- URL 파라미터 자동 검증
- 파일 경로 정규화 및 검증
- 허용 목록 기반 필터링

#### 계층 2: 출력 인코딩

- 자동 HTML 이스케이프
- 속성 값 인코딩
- JavaScript 컨텍스트 이스케이프

#### 계층 3: 실행 방지

- 위험한 태그 제거
- 인라인 이벤트 핸들러 차단
- 동적 코드 실행 방지

#### 계층 4: 컨텍스트 격리

- CSP(Content Security Policy) 지원
- 샌드박스 환경
- 최소 권한 원칙

---

## 사용 철학

### 점진적 개선 (Progressive Enhancement)

```javascript
// 레벨 1: 기본 사용
<script type="module">
  import IMCAT from './imcat-ui.js';
  IMCAT('#btn').on('click', () => alert('클릭!'));
</script>

// 레벨 2: 모듈 사용
<script type="module">
  import IMCAT from './imcat-ui.js';
  const modal = await IMCAT.use('modal');
  modal.show('내용');
</script>

// 레벨 3: SPA 애플리케이션
<nav>
  <a catui-href="views/home.html">홈</a>
  <a catui-href="views/products.html">상품</a>
</nav>

<script type="module">
  import IMCAT from './imcat-ui.js';
  
  // 라우트 설정 불필요! catui-href가 자동 처리
  
  // 모듈 사용
  const [modal, form] = await IMCAT.use('modal', 'form');
</script>
```

### 설정보다 관습 (Convention over Configuration)

```javascript
// ❌ 복잡한 설정 불필요
const modal = new Modal({
  backdrop: true,
  keyboard: true,
  focus: true,
  show: false
});

// ✅ 기본값으로 즉시 사용
const modal = await IMCAT.use('modal');
modal.show('내용'); // 합리적인 기본 동작
```

### 명시적 > 암시적 (Explicit over Implicit)

```javascript
// ✅ 명시적 로딩
const tooltip = await IMCAT.use('tooltip');
tooltip.init('[data-tooltip]');

// ❌ 자동 초기화 지양 (예측 불가능)
// 프레임워크가 자동으로 모든 것을 초기화하지 않음
```

---

## 🎬 완전한 SPA 애플리케이션 예제

### 1. index.html

```html
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IMCAT UI - SPA Demo</title>
  <link rel="stylesheet" href="imcat-ui.css">
</head>
<body>
  <!-- 네비게이션 -->
  <nav>
    <a catui-href="views/home.html">홈</a>
    <a catui-href="views/products.html">상품</a>
    <a catui-href="views/about.html">회사소개</a>
  </nav>

  <!-- 콘텐츠 영역 -->
  <main id="app"></main>

  <script type="module">
    import IMCAT from './imcat-ui.js';

    // 라우트 설정 불필요! catui-href가 자동으로 파일 경로 분석
    
    // 옵션: 라이프사이클 훅 (필요시)
    IMCAT.view.beforeLoad((path) => {
      console.log('페이지 로드:', path);
    });
  </script>
</body>
</html>
```

#### PHP 라우터 환경 예제

```html
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IMCAT UI - PHP 환경</title>
  <link rel="stylesheet" href="imcat-ui.css">
</head>
<body>
  <nav>
    <a catui-href="views/home.php">홈</a>
    <a catui-href="views/products.php">상품</a>
    <a catui-href="views/user/profile.php">프로필</a>
  </nav>

  <main id="app"></main>

  <script type="module">
    import IMCAT from './imcat-ui.js';
    // PHP 파일도 자동으로 로드됨
  </script>
</body>
</html>
```

### 2. views/home.html

```html
<div class="home">
  <h1>환영합니다!</h1>
  <p>IMCAT UI로 만든 SPA 애플리케이션입니다.</p>
  <button id="show-modal">모달 보기</button>
</div>

<script>
// IMCAT 자동 상속
const Modal = await IMCAT.use('modal');
const modalInstance = new Modal();

// 인스턴스 등록 - 메모리 누수 방지
IMCAT.view.registerInstance(modalInstance);

IMCAT('#show-modal').on('click', () => {
  modalInstance.show('안녕하세요!');
});

// 다른 페이지로 이동 시 자동으로 modalInstance.destroy() 호출
</script>
```

### 3. views/products.html (예제)

```html
<div class="products">
  <h1>상품 목록</h1>
  <ul id="product-list"></ul>
</div>

<script>
// API 호출
fetch('/api/products')
  .then(res => res.json())
  .then(products => {
    const html = products.map(p => 
      `<li><a catui-href="views/product-detail.html?id=${p.id}">${p.name}</a></li>`
    ).join('');
    
    IMCAT('#product-list').html(html);
  });
</script>
```

### 4. views/product-detail.html

```html
<div class="product-detail">
  <h1 id="product-name"></h1>
  <p id="product-desc"></p>
  <button id="add-cart">장바구니 추가</button>
</div>

<script>
// URL 파라미터 사용
const { id } = IMCAT.view.params();

// 상품 상세 로드
fetch(`/api/products/${id}`)
  .then(res => res.json())
  .then(product => {
    IMCAT('#product-name').text(product.name);
    IMCAT('#product-desc').text(product.description);
  });

// 토스트 모듈 로드 및 인스턴스 등록
const Toast = await IMCAT.use('toast');
const toastInstance = new Toast();
IMCAT.view.registerInstance(toastInstance);

// 장바구니 추가
IMCAT('#add-cart').on('click', () => {
  toastInstance.show('장바구니에 추가되었습니다!');
});

// 페이지 이탈 시 자동으로 정리됨
</script>
```

### 5. views/products.php (PHP 환경 예제)

```php
<?php
// 서버 측 데이터 처리
$products = getProducts(); // DB에서 상품 조회
?>

<div class="products">
  <h1>상품 목록 (PHP)</h1>
  <ul id="product-list">
    <?php foreach ($products as $product): ?>
      <li>
        <a catui-href="views/product-detail.php?id=<?= $product['id'] ?>">
          <?= htmlspecialchars($product['name']) ?>
        </a>
      </li>
    <?php endforeach; ?>
  </ul>
</div>

<script>
// IMCAT 자동 상속 - 클라이언트 측 기능
IMCAT('#product-list a').on('click', (e) => {
  console.log('상품 클릭:', e.target.textContent);
});

// 추가 데이터 로드 시
async function loadMoreProducts() {
  const response = await fetch('/api/products');
  const data = await response.json();
  
  const html = data.map(p => 
    `<li><a catui-href="views/product-detail.php?id=${p.id}">${p.name}</a></li>`
  ).join('');
  
  IMCAT('#product-list').append(html);
}
</script>
```

**PHP 환경의 장점:**

- ✅ **서버 사이드 렌더링** - PHP로 초기 HTML 생성
- ✅ **클라이언트 사이드 향상** - IMCAT으로 SPA 기능 추가
- ✅ **하이브리드 접근** - 서버/클라이언트 장점 결합
- ✅ **SEO 최적화** - 서버에서 완전한 HTML 제공
- ✅ **점진적 개선** - 기존 PHP 사이트에 SPA 기능 추가 가능

**핵심 포인트:**

- ✅ **라우트 설정 불필요** - 파일 경로를 직접 사용
- ✅ **catui-href** 속성으로 SPA 네비게이션
- ✅ 각 뷰에서 **IMCAT 자동 상속** 사용
- ✅ **동적 모듈 로딩** (`await IMCAT.use()`)
- ✅ **쿼리 파라미터** 지원 (`IMCAT.view.params()`)
- ✅ **자동 메모리 관리** - 뷰 전환 시 인스턴스 자동 정리
- ✅ **HTML/PHP 모두 지원** - 유연한 환경 지원
- ✅ 빌드 과정 없이 **즉시 실행 가능**

---

## 📦 배포 전략

### CDN 배포

```html
<!-- 개발 버전 -->
<script type="module" src="https://cdn.imcat.io/ui/1.0.0/imcat-ui.js"></script>

<!-- 프로덕션 버전 (minified) -->
<script type="module" src="https://cdn.imcat.io/ui/1.0.0/imcat-ui.min.js"></script>
```

### 로컬 사용

```text
project/
├── libs/
│   └── imcat-ui/
│       ├── imcat-ui.js
│       ├── imcat-ui.css
│       └── modules/
│           ├── modal.js
│           ├── dropdown.js
│           └── ...
└── index.html
```

### 버전 관리

- 시맨틱 버저닝 (Semantic Versioning)
- 하위 호환성 유지
- 명확한 변경 로그

---

## 🎨 스타일링 전략

### CSS 독립성

```css
/* 모든 스타일은 접두사 사용 */
.imcat-modal { }
.imcat-dropdown { }
.imcat-btn { }

/* CSS 변수로 커스터마이징 */
:root {
  --imcat-primary: #007bff;
  --imcat-radius: 4px;
  --imcat-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
```

### 스타일 로딩

```javascript
// 모듈과 함께 CSS 자동 로딩
const modal = await IMCAT.use('modal');
// modal.css도 자동으로 로드됨
```

---

## 🔧 개발 원칙

### 1. 단순성 우선 (Simplicity First)

- 복잡한 추상화 지양
- 이해하기 쉬운 코드
- 명확한 API

### 2. 성능 최적화 (Performance Optimized)

- 불필요한 DOM 조작 최소화
- 이벤트 위임 활용
- 메모리 누수 방지
- 효율적인 캐싱

### 3. 확장 가능성 (Extensibility)

- 플러그인 시스템
- 커스텀 모듈 추가 가능
- 훅(Hook) 시스템

### 4. 테스트 가능성 (Testability)

- 순수 함수 우선
- 의존성 주입 지원
- 모의 객체(Mock) 용이

### 5. 보안 우선 (Security First)

- XSS 공격 방어를 기본으로 제공
- 모든 사용자 입력 자동 이스케이프
- 안전한 기본값, 명시적 위험 허용
- CSP(Content Security Policy) 호환

---

## 📚 문서화 원칙

### API 문서

- 모든 공개 API는 JSDoc 주석
- 실용적인 예제 코드
- 일반적인 사용 사례

### 가이드

- 빠른 시작 가이드
- 각 모듈별 상세 가이드
- 마이그레이션 가이드
- 베스트 프랙티스

---

## 🚀 로드맵

### Phase 1: 코어 구현

- [ ] DOM 유틸리티
- [ ] 이벤트 시스템
- [ ] 모듈 로더
- [ ] 뷰 라우터 (SPA 지원)
- [ ] 로딩 인디케이터 (자동 표시)
- [ ] XSS 보안 필터 (자동 이스케이프/새니타이징)
- [ ] 기본 유틸리티

### Phase 2: 기본 모듈

- [ ] Modal
- [ ] Dropdown
- [ ] Tooltip
- [ ] Tabs
- [ ] Alert

### Phase 3: 확장 모듈

- [ ] Form Validation
- [ ] Ajax/Fetch Wrapper
- [ ] Animation
- [ ] State Management

### Phase 4: 고급 기능

- [ ] 플러그인 시스템
- [ ] 테마 시스템

---

## 🎓 영감을 받은 프로젝트

- **jQuery**: 직관적인 API, 크로스 브라우저 호환성
- **Alpine.js**: 경량, 선언적 접근
- **Petite-Vue**: 최소한의 크기, ES 모듈
- **Umbrella JS**: 모던 jQuery 대안

---

## 📄 라이센스

MIT License - 자유롭게 사용, 수정, 배포 가능

---

## 🤝 기여 가이드

- 순수 ES6+ 자바스크립트만 사용
- TypeScript 사용 금지
- 코드 스타일 가이드 준수
- 테스트 커버리지 유지
- 보안 검토 필수 (XSS, 인젝션 등)
- 문서화 필수

---

## 결론

IMCAT UI는 **즉시 사용 가능한**, **경량의**, **안전한**, **모던한** 웹 프레임워크입니다.

복잡한 빌드 프로세스 없이, TypeScript 없이, 순수 ES6+ 자바스크립트만으로
동적 모듈 로딩, 우아한 API, 그리고 **내장 XSS 방어**를 제공합니다.

**정적 HTML**과 **PHP 환경** 모두에서 동작하며, 기존 웹사이트에 SPA 기능을 점진적으로 추가할 수 있습니다.

**핵심 가치:**

- ⚡ 빠른 시작
- 🪶 경량화
- 🔌 플러그 앤 플레이
- 🎯 필요한 것만 로딩
- 💎 직관적인 API
- ⏳ 자동 로딩 표시
- 🧹 자동 메모리 관리
- 🔒 내장 보안 (XSS 방어)
- 🌐 다양한 환경 지원 (HTML/PHP)
